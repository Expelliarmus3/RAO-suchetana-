{% extends "layout.html" %}

{% block content %}
<style>
    /* --- 1. GLOBAL BACKGROUND STYLES --- */
    body {
        background-color: #f8fafc; /* Light base */
        /* Combined Backgrounds:
           1. The original technical gray grid.
           2-4. New subtle pastel micro-dots for a "cute design" feel.
        */
        background-image: 
            radial-gradient(#cbd5e1 1px, transparent 1px), /* Original Grid */
            radial-gradient(rgba(167, 139, 250, 0.2) 1.5px, transparent 1.5px), /* Cute Purple Dot */
            radial-gradient(rgba(34, 211, 238, 0.2) 1.5px, transparent 1.5px), /* Cute Cyan Dot */
            radial-gradient(rgba(244, 114, 182, 0.2) 1.5px, transparent 1.5px); /* Cute Pink Dot */
        
        /* Varying sizes create a scattered, non-uniform look */
        background-size: 
            30px 30px,  /* Grid size */
            90px 90px,  /* Purple scatter */
            130px 130px, /* Cyan scatter */
            170px 170px; /* Pink scatter */
            
        /* Offset positions so they don't overlap perfectly */
        background-position:
            0 0,
            20px 20px,
            60px 80px,
            100px 40px;

        min-height: 100vh;
        position: relative;
        overflow-x: hidden; /* Ensures blobs don't cause horizontal scroll */
    }

    /* Floating Blobs for Color Pop */
    .blob {
        position: absolute; filter: blur(80px); z-index: -1; opacity: 0.6;
        animation: float 10s infinite alternate ease-in-out;
    }
    .blob-1 { width: 400px; height: 400px; background: #a78bfa; top: -100px; left: -100px; }
    .blob-2 { width: 350px; height: 350px; background: #22d3ee; top: 200px; right: -50px; animation-delay: -5s; }

    @keyframes float { 0% { transform: translate(0, 0); } 100% { transform: translate(40px, 40px); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .fade-in { animation: slideUp 0.6s ease-out forwards; position: relative; z-index: 1; }

    /* --- 2. HERO & TYPOGRAPHY --- */
    .hero-box { text-align: center; margin-top: 50px; margin-bottom: 50px; }
    
    .gradient-text {
        background: linear-gradient(135deg, #1e293b 0%, #4f46e5 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800;
    }
    
    .hero-title { font-size: 48px; font-weight: 800; color: #0f172a; margin-bottom: 15px; line-height: 1.1; letter-spacing: -1px; }

    /* --- 3. COOL GLASS SEARCH BAR --- */
    .search-wrap { 
        background: rgba(255, 255, 255, 0.85); /* Glass Effect */
        backdrop-filter: blur(12px);
        padding: 10px; 
        border-radius: 20px; 
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.05); 
        border: 2px solid white; 
        display: flex; align-items: center; 
        max-width: 750px; margin: 0 auto; 
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        position: relative;
    }
    
    .search-wrap:hover { transform: translateY(-3px); box-shadow: 0 25px 60px rgba(0, 0, 0, 0.08); }

    .search-wrap:focus-within {
        transform: translateY(-3px);
        box-shadow: 0 30px 70px rgba(79, 70, 229, 0.2);
        border-color: #818cf8; /* Purple Glow Border */
    }
    
    .search-wrap input { 
        flex: 1; border: none; padding: 15px 25px; font-size: 16px; 
        outline: none; background: transparent; color: #0f172a; font-weight: 500;
    }
    .search-wrap input::placeholder { color: #94a3b8; font-weight: 400; }
    
    .btn-optimize {
        background: #0f172a; color: white; border: none; padding: 14px 28px; 
        border-radius: 14px; font-weight: 600; cursor: pointer; transition: 0.3s;
        display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 20px rgba(15, 23, 42, 0.15);
    }
    .btn-optimize:hover { background: #4f46e5; transform: scale(1.05); }

    /* --- 4. FEATURE CARDS --- */
    .features-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 900px; margin: 50px auto; }
    .feature-card { 
        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
        padding: 30px; border-radius: 20px; border: 1px solid white; 
        transition: 0.3s; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.02);
    }
    .feature-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.05); border-color: #e2e8f0; }
    .icon-box { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 20px; }

    /* --- 5. RESULTS GRID --- */
    .res-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; margin-top: 40px; text-align: left; animation: slideUp 0.5s ease-out; }
    .res-card { 
        background: white; border: 1px solid #e2e8f0; border-radius: 20px; 
        padding: 30px; box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05); 
    }
    
    .meta-item { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; padding: 12px 0; font-size: 14px; }
    .skill-tag { background: #eef2ff; color: #4f46e5; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; display: inline-block; margin: 4px 2px; border: 1px solid #c7d2fe; }

    /* Textarea Styling */
    textarea {
        width: 100%; height: 450px; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0;
        font-family: 'Plus Jakarta Sans', sans-serif; color: #334155; font-size: 14px; line-height: 1.8;
        resize: none; outline: none; background: #f8fafc; transition: 0.2s;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
    }
    textarea:focus { background: white; border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

    /* --- 6. RESUME UPLOAD BOX --- */
    .upload-area {
        border: 2px dashed #cbd5e1; border-radius: 16px; padding: 30px;
        text-align: center; background: #f8fafc; cursor: pointer; position: relative;
        transition: 0.2s; margin-bottom: 15px;
    }
    .upload-area:hover { border-color: #6366f1; background: #eef2ff; }
    .upload-area input { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
    .upload-icon { font-size: 32px; color: #6366f1; margin-bottom: 10px; }
    .upload-label { font-size: 14px; font-weight: 700; color: #475569; }

</style>

<div class="blob blob-1"></div>
<div class="blob blob-2"></div>

<div class="fade-in">
    <div class="hero-box">
        <div style="margin-bottom: 20px;">
            <span style="background: white; color: #6366f1; padding: 8px 16px; border-radius: 30px; font-size: 11px; font-weight: 800; letter-spacing: 1px; border: 1px solid #e0e7ff; box-shadow: 0 4px 10px rgba(0,0,0,0.03);">âœ¨ AI POWERED </span>
        </div>
        <h1 class="hero-title">Research Application <span class="gradient-text">Optimizer</span></h1>
        <p style="color:#64748b; font-size:18px; margin-bottom:50px; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6;">
            Turn complex research papers into hyper-personalized internship applications in seconds.
        </p>

        <div class="search-wrap">
            <span style="padding-left: 20px; color: #6366f1; font-size: 18px;"><i class="fa-solid fa-link"></i></span>
            <input type="text" id="paperUrl" placeholder="Paste Research Paper Link (arXiv, Semantic Scholar)...">
            <button onclick="runOptimizer()" class="btn-optimize" id="opt-btn">
                <i class="fa-solid fa-wand-magic-sparkles"></i> Optimize
            </button>
        </div>
    </div>

    <div id="featuresArea" class="features-grid">
        <div class="feature-card">
            <div class="icon-box" style="background: #eff6ff; color: #3b82f6;"><i class="fa-solid fa-robot"></i></div>
            <h3 style="font-size: 18px; margin-bottom: 8px; font-weight: 700;">AI Summarizer</h3>
            <p style="font-size: 14px; color: #64748b; line-height: 1.6;">Instantly extracts key topics and methods from complex PDFs.</p>
        </div>
        <div class="feature-card">
            <div class="icon-box" style="background: #f0fdf4; color: #16a34a;"><i class="fa-solid fa-check-double"></i></div>
            <h3 style="font-size: 18px; margin-bottom: 8px; font-weight: 700;">Skill Matching</h3>
            <p style="font-size: 14px; color: #64748b; line-height: 1.6;">Identifies technical gaps between your resume and the paper.</p>
        </div>
        <div class="feature-card">
            <div class="icon-box" style="background: #f5f3ff; color: #7c3aed;"><i class="fa-solid fa-envelope-open-text"></i></div>
            <h3 style="font-size: 18px; margin-bottom: 8px; font-weight: 700;">Smart Drafting</h3>
            <p style="font-size: 14px; color: #64748b; line-height: 1.6;">Writes professional, context-aware applications to professors.</p>
        </div>
    </div>

    <div id="result-area" class="res-grid" style="display:none;">
        
        <div class="res-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="font-size:20px; color:#0f172a; font-weight: 700;"><i class="fa-solid fa-file-pen" style="color: #6366f1; margin-right: 8px;"></i> Generated Draft</h3>
                <span style="font-size:12px; color:#64748b; background:#f1f5f9; padding:6px 12px; border-radius:8px; font-weight: 600;">Editable Mode</span>
            </div>
            <textarea id="app-text"></textarea>
        </div>

        <div style="display:flex; flex-direction:column; gap:25px;">
            
            <div class="res-card" style="padding: 30px;">
                <div class="meta-item"><span style="color:#64748b; font-weight:600;">Citation Score</span><span id="cit-score" style="color:#0f172a; font-weight:800;">-</span></div>
                <div class="meta-item"><span style="color:#64748b; font-weight:600;">Est. Vacancies</span><span id="vacancies" style="color:#0f172a; font-weight:800;">-</span></div>
                <div class="meta-item" style="border:none;"><span style="color:#64748b; font-weight:600;">Competition</span><span id="applicants" style="color:#0f172a; font-weight:800;">-</span></div>
            </div>

            <div class="res-card">
                <h4 style="margin-bottom:15px; font-size:16px; color:#0f172a; font-weight: 700;">ðŸ“„ Quick Summary</h4>
                <p id="paper-summary" style="font-size:14px; color:#475569; line-height:1.7;">...</p>
            </div>

            <div class="res-card">
                <h4 style="margin-bottom:15px; font-size:16px; color:#0f172a; font-weight: 700;">âš¡ Required Skills</h4>
                <div id="skills-container"></div>
            </div>
            
            <div class="res-card">
                <h4 style="margin-bottom:15px; font-size:16px; color:#0f172a; font-weight: 700;">ðŸ“Ž Attach Resume</h4>
                <form id="appForm">
                    <div class="upload-area" id="drop-zone">
                        <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                        <div class="upload-label" id="file-label">Click to Upload PDF</div>
                        <input type="file" id="resumeFile" name="resume" accept=".pdf" onchange="updateFileName()">
                    </div>
                </form>
                
                <button onclick="submitApp()" id="btn-apply" style="width:100%; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color:white; padding:18px; border-radius:12px; border:none; font-weight:700; cursor:pointer; font-size:16px; transition: transform 0.2s; box-shadow: 0 10px 20px rgba(22, 163, 74, 0.2);">
                    Apply Now <i class="fa-solid fa-paper-plane" style="margin-left:8px;"></i>
                </button>
            </div>

        </div>
    </div>
</div>

<script>
    async function runOptimizer() {
        const btn = document.getElementById('opt-btn');
        const resultArea = document.getElementById('result-area');
        const featuresArea = document.getElementById('featuresArea'); 
        
        // Loading State
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...';
        btn.style.opacity = "0.7";
        
        try {
            const url = document.getElementById('paperUrl').value;
            if(!url) { alert("Please enter a URL!"); btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Optimize'; btn.style.opacity = "1"; return; }

            const response = await fetch('/optimize', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: url})
            });
            const data = await response.json();
            
            if(data.error) {
                 alert("Error: " + data.error);
                 btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Optimize';
                 return;
            }

            // FILL DATA
            document.getElementById('app-text').value = data.application;
            document.getElementById('cit-score').innerText = data.analysis.citation_score;
            document.getElementById('vacancies').innerText = data.analysis.vacancies;
            document.getElementById('applicants').innerText = data.analysis.applicants;
            document.getElementById('paper-summary').innerText = data.analysis.summary;
            
            const skillsDiv = document.getElementById('skills-container');
            skillsDiv.innerHTML = '';
            data.analysis.skills.forEach(skill => {
                skillsDiv.innerHTML += `<span class="skill-tag">${skill}</span>`;
            });

            // SWITCH VIEW
            featuresArea.style.display = 'none';
            resultArea.style.display = 'grid';
            
            // Reset Button
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Done';
            btn.style.background = "#16a34a"; 
            
            setTimeout(() => {
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Optimize';
                btn.style.background = "#0f172a";
                btn.style.opacity = "1";
            }, 3000);
            
        } catch (error) {
            console.error(error);
            alert("Error fetching data. Check console.");
            btn.innerHTML = 'Retry';
        }
    }

    function updateFileName() {
        const input = document.getElementById('resumeFile');
        const label = document.getElementById('file-label');
        if(input.files && input.files[0]) {
            label.innerText = input.files[0].name;
            label.style.color = "#16a34a"; 
            label.style.fontWeight = "700";
        }
    }

    async function submitApp() {
        const fileInput = document.getElementById('resumeFile');
        const textInput = document.getElementById('app-text'); 
        const btn = document.getElementById('btn-apply');

        if (!fileInput.files[0]) { alert("Please attach your resume first!"); return; }
        if (!textInput.value) { alert("Please generate or write an email first!"); return; }

        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Sending...';

        const formData = new FormData();
        formData.append('resume', fileInput.files[0]);
        formData.append('cover_letter', textInput.value); 

        try {
            const response = await fetch('/submit_application', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if(data.status === 'success') {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Sent!';
                btn.style.background = "#059669";
                alert("Success! The Professor can now view your Cover Letter and Resume.");
            }
        } catch (e) {
            console.error(e);
            alert("Upload failed.");
            btn.innerHTML = 'Retry';
        }
    }
</script>
{% endblock %}